## Общая информация
- **TransportType**: Cargo-Регион (uid: `205006fa-3cc0-11ea-9463-7824af43f0ed`)
- **API**: `https://08615a563fb9b4f8.mokky.dev`
- **Доступные города в billingAddresses**: Красноярск, Новосибирск, Барнаул, Братск
- **Города с терминалами**: Красноярск, Новосибирск (в billingAddresses)
- **Города с адресами (есть улицы)**: Красноярск, Новосибирск, Братск
- **Доступные направления**:
  - Красноярск → Новосибирск (зона 4) ✅
  - Красноярск → Барнаул (зона 4) ✅
  - Красноярск → Братск (зона 6) ✅
  - Новосибирск → Красноярск (зона 4) ✅
  - Новосибирск → Барнаул (зона 4) ✅
  - Новосибирск → Братск (зона 10) ✅
  - Братск → Новосибирск (зона 3) ✅
  - Братск → Красноярск (зона 1) ✅
  - Братск → Барнаул (зона 10) ✅

## Важные замечания
- Терминалы находятся в той же таблице `billingAddresses`, просто у них не заполнена улица
- Таблица `terminals` содержит только дополнительную информацию о терминалах
- Для адреса используется тот же `billingAddress`, что и для терминала в этом городе (через `uidBillingAddress` из `terminals`)

---

## Кейс 1: Терминал → Терминал ✅

**Направление**: Красноярск → Новосибирск

**Параметры**:
- От: Красноярск (терминал "Красноярск, Промысловая ул, 25а, 11")
- До: Новосибирск (терминал "Новосибирск, Толмачевское шоссе, 16")
- Тип перевозки: Cargo-Регион
- Груз: 1 место, 10 кг, 30×20×15 см

**Ожидаемое поведение**:
- ✅ Забор: **0₽** (выбран терминал)
- ✅ Доставка: **0₽** (выбран терминал)
- ✅ Перевозка: рассчитывается по tariffZone из tariffZones (зона 4)
- ✅ takeDeliverFrom: uid `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, зона A (Красноярск)
- ✅ takeDeliverTo: uid `85392a9d-5936-11eb-a7ef-d89d672a90e6`, зона C (Новосибирск)
- ✅ tariffZone: uidTakeLocality `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, uidDeliverLocality `85392a9d-5936-11eb-a7ef-d89d672a90e6`, зона 4

**Что проверить**:
1. Терминалы загружаются и отображаются в списке при выборе города
2. При выборе терминала забор = 0₽
3. При выборе терминала доставка = 0₽
4. Перевозка рассчитывается корректно по зоне 4
5. В детализации видно, что забор и доставка = 0₽
6. В консоли: `takeDeliverFrom` и `takeDeliverTo` найдены, `tariffZone` найдена

**Проверка в консоли**:
```javascript
// Должно быть в логах:
takeDeliverFrom найден через uidBillingAddress: {uid: '7f40e4fa-5936-11eb-a7ef-d89d672a90e6', ...}
takeDeliverTo найден через uidBillingAddress: {uid: '85392a9d-5936-11eb-a7ef-d89d672a90e6', ...}
Тарифная зона найдена: {tariffZone: 4, ...}
```

---

## Кейс 2: Адрес → Терминал ✅

**Направление**: Красноярск → Новосибирск

**Параметры**:
- От: Красноярск (адрес "Авиаторов ул" или "Пограничников ул")
- До: Новосибирск (терминал "Новосибирск, Толмачевское шоссе, 16")
- Тип перевозки: Cargo-Регион
- Груз: 1 место, 10 кг, 30×20×15 см

**Реальные данные из API**:
- Терминал Красноярск: UID `6fc2398d-c532-11e8-942c-001a7dda7113`, billingAddress `4dc6ccfb-dfce-11ec-a806-d89d672a90e7`
- Адрес Красноярск: UID `4dc6ccfc-dfce-11ec-a806-d89d672a90e7`, улица "Авиаторов ул"
- Адрес Красноярск: UID `213776ff-9db6-11ef-9fb7-0cc47aa88e61`, улица "Пограничников ул"

**Ожидаемое поведение**:
- ✅ Забор: рассчитывается по зоне A из takeDeliverFrom
- ✅ Доставка: **0₽** (выбран терминал)
- ✅ Перевозка: рассчитывается по tariffZone из tariffZones (зона 4)
- ✅ takeDeliverFrom: uid `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, зона A (Красноярск) - используется тот же, что и для терминала
- ✅ takeDeliverTo: uid `85392a9d-5936-11eb-a7ef-d89d672a90e6`, зона C (Новосибирск)
- ✅ tariffZone: зона 4

**Что проверить**:
1. Адреса подставляются из billingAddresses при вводе города
2. При выборе адреса забор рассчитывается по зоне A
3. При выборе терминала доставка = 0₽
4. Перевозка рассчитывается корректно
5. В детализации видно стоимость забора и доставка = 0₽
6. В консоли: `fromAddress найден через терминал` - используется тот же billingAddress, что и для терминала

**Проверка в консоли**:
```javascript
// Должно быть в логах:
fromAddress найден через терминал: {uid: '4dc6ccfb-dfce-11ec-a806-d89d672a90e7', ...}
takeDeliverFrom найден: {uid: '7f40e4fa-5936-11eb-a7ef-d89d672a90e6', ...}
Тарифная зона найдена: {tariffZone: 4, ...}
```

---

## Кейс 3: Терминал → Адрес ✅

**Направление**: Красноярск → Новосибирск

**Параметры**:
- От: Красноярск (терминал "Красноярск, Промысловая ул, 25а, 11")
- До: Новосибирск (адрес "Станционная ул")
- Тип перевозки: Cargo-Регион
- Груз: 1 место, 10 кг, 30×20×15 см

**Реальные данные из API**:
- Терминал Новосибирск: UID `3f6a8bdc-e647-11e8-a69f-74d02b985cb1`, billingAddress `4dc6cd45-dfce-11ec-a806-d89d672a90e7`
- Адрес Новосибирск: UID `4dc6cd46-dfce-11ec-a806-d89d672a90e7`, улица "Станционная ул"

**Ожидаемое поведение**:
- ✅ Забор: **0₽** (выбран терминал)
- ✅ Доставка: рассчитывается по зоне C из takeDeliverTo
- ✅ Перевозка: рассчитывается по tariffZone из tariffZones (зона 4)
- ✅ takeDeliverFrom: uid `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, зона A (Красноярск)
- ✅ takeDeliverTo: uid `85392a9d-5936-11eb-a7ef-d89d672a90e6`, зона C (Новосибирск) - используется тот же, что и для терминала
- ✅ tariffZone: зона 4

**Что проверить**:
1. Терминал загружается и отображается
2. При выборе терминала забор = 0₽
3. Адреса подставляются из billingAddresses при вводе города
4. При выборе адреса доставка рассчитывается по зоне C
5. Перевозка рассчитывается корректно
6. В детализации видно забор = 0₽ и стоимость доставки
7. В консоли: `toAddress найден через терминал` - используется тот же billingAddress, что и для терминала

**Проверка в консоли**:
```javascript
// Должно быть в логах:
toAddress найден через терминал: {uid: '4dc6cd45-dfce-11ec-a806-d89d672a90e7', ...}
takeDeliverTo найден: {uid: '85392a9d-5936-11eb-a7ef-d89d672a90e6', ...}
Тарифная зона найдена: {tariffZone: 4, ...}
```

---

## Кейс 4: Адрес → Адрес ✅

**Направление**: Красноярск → Новосибирск

**Параметры**:
- От: Красноярск (адрес "Авиаторов ул" или "Пограничников ул")
- До: Новосибирск (адрес "Станционная ул")
- Тип перевозки: Cargo-Регион
- Груз: 1 место, 10 кг, 30×20×15 см

**Реальные данные из API**:
- Адрес Красноярск: UID `4dc6ccfc-dfce-11ec-a806-d89d672a90e7`, улица "Авиаторов ул"
- Адрес Красноярск: UID `213776ff-9db6-11ef-9fb7-0cc47aa88e61`, улица "Пограничников ул"
- Адрес Новосибирск: UID `4dc6cd46-dfce-11ec-a806-d89d672a90e7`, улица "Станционная ул"

**Ожидаемое поведение**:
- ✅ Забор: рассчитывается по зоне A из takeDeliverFrom
- ✅ Доставка: рассчитывается по зоне C из takeDeliverTo
- ✅ Перевозка: рассчитывается по tariffZone из tariffZones (зона 4)
- ✅ takeDeliverFrom: uid `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, зона A (Красноярск)
- ✅ takeDeliverTo: uid `85392a9d-5936-11eb-a7ef-d89d672a90e6`, зона C (Новосибирск)
- ✅ tariffZone: зона 4

**Что проверить**:
1. Адреса подставляются из billingAddresses при вводе города
2. При выборе адреса забор рассчитывается по зоне A
3. При выборе адреса доставка рассчитывается по зоне C
4. Перевозка рассчитывается корректно
5. В детализации видно стоимость забора и доставки
6. В консоли: оба адреса найдены через терминалы

**Проверка в консоли**:
```javascript
// Должно быть в логах:
fromAddress найден через терминал: {uid: '4dc6ccfb-dfce-11ec-a806-d89d672a90e7', ...}
toAddress найден через терминал: {uid: '4dc6cd45-dfce-11ec-a806-d89d672a90e7', ...}
takeDeliverFrom найден: {uid: '7f40e4fa-5936-11eb-a7ef-d89d672a90e6', ...}
takeDeliverTo найден: {uid: '85392a9d-5936-11eb-a7ef-d89d672a90e6', ...}
Тарифная зона найдена: {tariffZone: 4, ...}
```

---

## Кейс 5: Другое направление (Красноярск → Барнаул) ✅

**Направление**: Красноярск → Барнаул

**Параметры**:
- От: Красноярск (терминал "Красноярск, Промысловая ул, 25а, 11" или адрес)
- До: Барнаул (терминал или адрес)
- Тип перевозки: Cargo-Регион
- Груз: 1 место, 10 кг, 30×20×15 см

**Ожидаемое поведение**:
- ✅ tariffZone: зона 4 (из tariffZones)
- ✅ takeDeliverFrom: uid `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, зона A (Красноярск)
- ✅ takeDeliverTo: uid `f692155c-dcfa-11ed-9f4b-22025c0500b5`, зона C (Барнаул)

**Реальные данные из API**:
- Барнаул: takeDeliver UID `f692155c-dcfa-11ed-9f4b-22025c0500b5`, billingAddress `4dc6cc5c-dfce-11ec-a806-d89d672a90e7`, зона C
- Направление Красноярск → Барнаул: зона 4 ✅

**Что проверить**:
1. Разные направления работают корректно
2. Тарифные зоны находятся правильно
3. Расчет перевозки использует правильную зону
4. В консоли: `tariffZone` найдена для этого направления

**Проверка в консоли**:
```javascript
// Должно быть в логах:
takeDeliverFrom найден: {uid: '...', tariffZone: 'A', ...}
takeDeliverTo найден: {uid: '...', tariffZone: 'C', ...}
Тарифная зона найдена: {tariffZone: ..., ...}
```

---

## Кейс 6: Проверка зон забора/доставки ✅

**Доступные зоны в takeDelivers** (для Cargo-Регион):
- **Зона A**: Красноярск (UID `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`) ✅
- **Зона B**: Братск (UID `771eac11-5c59-11ee-9f7c-00e04c6824b0`) ✅
- **Зона C**: 
  - Новосибирск (UID `85392a9d-5936-11eb-a7ef-d89d672a90e6`) ✅
  - Барнаул (UID `f692155c-dcfa-11ed-9f4b-22025c0500b5`) ✅
  - Братск (несколько записей) ✅

**Доступные зоны для перевозки в tariffZones**:
- **Зона 1**: Братск → Красноярск ✅
- **Зона 2**: Красноярск → Красноярск, Новосибирск → Новосибирск ✅
- **Зона 3**: Братск → Новосибирск ✅
- **Зона 4**: 
  - Красноярск → Новосибирск ✅
  - Красноярск → Барнаул ✅
  - Новосибирск → Красноярск ✅
  - Новосибирск → Барнаул ✅
- **Зона 6**: Красноярск → Братск ✅
- **Зона 10**: 
  - Новосибирск → Братск ✅
  - Братск → Барнаул ✅

**Что проверить**:
1. Для каждой зоны забора/доставки есть соответствующая тарифная сетка
2. Для каждой зоны перевозки есть соответствующая тарифная сетка
3. Расчет использует правильные тарифные сетки
4. В консоли: тарифные сетки найдены для всех зон

---

## Кейс 7: Проверка валидации городов и адресов

**Сценарий 1: Выбор недоступного города**
- Выбрать город, которого нет в `billingAddresses` (например: Москва, Санкт-Петербург, Омск)
- **Ожидаемое поведение**: 
  - ✅ Отображается форма запроса к менеджеру
  - ✅ Форма направлений всегда видна сверху
  - ✅ Сообщение "выберите направление выше"

**Сценарий 2: Выбор города без доступных улиц**
- Выбрать город из `billingAddresses`, но без доступных улиц (например: Барнаул)
- **Ожидаемое поведение**:
  - ✅ Отображается форма запроса улицы
  - ✅ Поле ввода улицы не скрыто
  - ✅ Форма запроса отображается динамически при вводе

**Сценарий 3: Ввод несуществующей улицы**
- Выбрать город с доступными улицами (Красноярск, Новосибирск, Братск)
- Ввести улицу, которой нет в `billingAddresses` (например: "Ленина ул" в Красноярске)
- **Ожидаемое поведение**:
  - ✅ Поле ввода улицы видно
  - ✅ Форма запроса улицы отображается динамически при вводе
  - ✅ Город и регион уже заполнены в форме запроса

**Реальные данные для проверки**:
- **Города с адресами**: Красноярск (2 адреса), Новосибирск (1 адрес), Братск (8 адресов)
- **Город без адресов**: Барнаул (есть в billingAddresses, но нет улиц)

---

## Рекомендации по тестированию

1. **Начните с Кейса 1** (Терминал → Терминал, Красноярск → Новосибирск) - самый простой, забор и доставка = 0, зона 4
2. **Затем Кейс 4** (Адрес → Адрес, Красноярск → Новосибирск) - проверяет расчет забора и доставки, зона 4
3. **Кейсы 2 и 3** - проверяют смешанные варианты (Адрес → Терминал и Терминал → Адрес)
4. **Кейс 5** - проверяет разные направления:
   - Красноярск → Барнаул (зона 4)
   - Красноярск → Братск (зона 6)
   - Новосибирск → Братск (зона 10)
   - Братск → Красноярск (зона 1)
   - Братск → Новосибирск (зона 3)
5. **Кейс 6** - проверяет наличие всех необходимых данных и зон
6. **Кейс 7** - проверяет валидацию и формы запроса:
   - Недоступный город (например: Москва)
   - Город без адресов (Барнаул)
   - Несуществующая улица в доступном городе

## Параметры груза для тестирования

Рекомендуется протестировать с разными параметрами:
- **Вес**: 10 кг, 50 кг, 100 кг, 200 кг, 500 кг
- **Объем**: 0.01 м³, 0.1 м³, 0.5 м³, 1 м³
- **Габариты**: 30×20×15 см, 50×40×30 см, 100×80×60 см
- **Опасный груз**: да/нет
- **Температурный режим**: да/нет

## Проверка в консоли браузера

При расчете проверьте логи в консоли:
- ✅ `takeDeliverFrom` и `takeDeliverTo` найдены
- ✅ `tariffZone` найдена
- ✅ Тарифные сетки найдены для забора, доставки и перевозки
- ✅ Расчеты выполнены корректно
- ✅ Для адресов: `fromAddress найден через терминал` или `toAddress найден через терминал`

## Типичные проблемы и их решения

1. **Тарифная зона не найдена**
   - Проверить, что используется правильный `takeDeliver` (тот же, что и для терминала)
   - Проверить логи: `fromAddress найден через терминал` или `toAddress найден через терминал`
   - Убедиться, что направление существует в `tariffZones` (см. список доступных направлений выше)

2. **Забор/доставка не рассчитываются**
   - Проверить, что выбран адрес (не терминал)
   - Проверить, что `takeDeliver` найден для этого `billingAddress`
   - Убедиться, что для города есть адреса с улицами в `billingAddresses`

3. **Терминалы не отображаются**
   - Проверить, что терминалы загружены из API
   - Проверить фильтрацию терминалов по городу
   - Убедиться, что город есть в `billingAddresses` (терминалы связаны через `uidBillingAddress`)

4. **Адреса не подставляются**
   - Проверить, что город выбран из `billingAddresses`
   - Убедиться, что для города есть адреса с заполненным полем `street`
   - Проверить логику поиска адресов через терминалы (используется тот же `billingAddress`)

5. **Отрицательные шаги в расчете забора/доставки** ✅ ИСПРАВЛЕНО
   - **Проблема**: Когда Платный Вес (ПВ) меньше `unitFrom` в тарифной сетке, расчет давал отрицательные шаги
   - **Пример**: ПВ = 50 кг, unitFrom = 500 кг → шаги = (50 - 500) / 1 = -450 ❌
   - **Решение**: 
     - Если ПВ < минимального unitFrom → используется минимальная стоимость (`startingPrice` первой строки)
     - Шаги не применяются (шаги = 0)
     - В детализации отображается сообщение о минимальной стоимости
   - **Проверка**: При ПВ = 50 кг и unitFrom = 500 кг стоимость забора должна быть 2195 ₽ (startingPrice), а не 1295 ₽

6. **Неправильный выбор тарифной строки для граничных значений** ✅ ИСПРАВЛЕНО
   - **Проблема**: Условие `payableWeight > unitFrom` исключало граничные значения, из-за чего для ПВ=100 не находилась строка с unitFrom=100
   - **Пример**: ПВ = 100 кг, строки тарифа: unitFrom=30 (unitTo=99.999), unitFrom=100 (unitTo=199.999)
     - Старое условие: 100 > 30 && 100 <= 99.999? НЕТ, 100 > 100 && 100 <= 199.999? НЕТ ❌
     - Новое условие: 100 >= 30 && 100 <= 99.999? НЕТ, 100 >= 100 && 100 <= 199.999? ДА ✅
   - **Решение**: 
     - Условие изменено на `payableWeight >= unitFrom && payableWeight <= unitTo` (включая границы)
     - Правильная обработка случая ПВ = unitFrom (шаги = 0, используется только startingPrice)
     - Правильная обработка случая step = 0 (фиксированная цена без шагов)
   - **Проверка**: При ПВ = 100 кг должна выбираться строка с unitFrom=100, а не unitFrom=500

7. **Проблема: 2 места стоили дешевле, чем 1 место** ✅ ИСПРАВЛЕНО
   - **Проблема**: Для ПВ=100 кг выбиралась неправильная тарифная строка (unitFrom=500 вместо unitFrom=100), что приводило к использованию минимальной стоимости
   - **Пример**: 
     - ПВ = 50 кг → строка unitFrom=30, стоимость = 363 + (50-30)/1 × 17 = 703 ₽ ✅
     - ПВ = 100 кг → неправильно выбиралась строка unitFrom=500, стоимость = 363 ₽ (минимальная) ❌
   - **Решение**: Исправлена логика выбора тарифной строки - теперь правильно обрабатываются все значения веса, включая граничные
   - **Проверка**: При ПВ = 100 кг должна выбираться строка с unitFrom=100, стоимость = 1518 + (100-100)/1 × 17 = 1518 ₽

## Актуальные данные из API (2025-01-21)

### TakeDeliver записи для основных городов:
- **Красноярск**: UID `7f40e4fa-5936-11eb-a7ef-d89d672a90e6`, зона A, billingAddress `4dc6ccfb-dfce-11ec-a806-d89d672a90e7`
- **Новосибирск**: UID `85392a9d-5936-11eb-a7ef-d89d672a90e6`, зона C, billingAddress `4dc6cd45-dfce-11ec-a806-d89d672a90e7`
- **Барнаул**: UID `f692155c-dcfa-11ed-9f4b-22025c0500b5`, зона C, billingAddress `4dc6cc5c-dfce-11ec-a806-d89d672a90e7`
- **Братск**: UID `7f40e487-5936-11eb-a7ef-d89d672a90e6`, зона C, billingAddress `4dc6cc80-dfce-11ec-a806-d89d672a90e7`

### Терминалы:
- **Красноярск**: UID `6fc2398d-c532-11e8-942c-001a7dda7113`, billingAddress `4dc6ccfb-dfce-11ec-a806-d89d672a90e7`
- **Новосибирск**: UID `3f6a8bdc-e647-11e8-a69f-74d02b985cb1`, billingAddress `4dc6cd45-dfce-11ec-a806-d89d672a90e7`

### Адреса с улицами:
- **Красноярск**: "Авиаторов ул" (UID `4dc6ccfc-dfce-11ec-a806-d89d672a90e7`), "Пограничников ул" (UID `213776ff-9db6-11ef-9fb7-0cc47aa88e61`)
- **Новосибирск**: "Станционная ул" (UID `4dc6cd46-dfce-11ec-a806-d89d672a90e7`)
- **Братск**: 8 адресов (промплощадки и промзоны)

